# ClawBoard Frontend Nginx Configuration
# Serves the React SPA and proxies API/WebSocket requests to backend

server {
    listen 80;
    server_name localhost;

    # ================================================
    # ROOT REDIRECT
    # ================================================
    # Redirect root path to dashboard
    location = / {
        return 302 /dashboard/;
    }

    # ================================================
    # WEBSOCKET PROXIES
    # ================================================
    # WebSocket endpoint with /api prefix (default for frontend)
    # EXACT MATCH to prevent path collisions
    location = /api/ws {
        proxy_pass http://clawboard-backend:3001/ws;
        proxy_http_version 1.1;
        
        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for long-lived WebSocket connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Alternative WebSocket endpoint (direct /ws path)
    # For cases where frontend uses direct VITE_WS_URL
    location = /ws {
        proxy_pass http://clawboard-backend:3001/ws;
        proxy_http_version 1.1;
        
        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for long-lived connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ================================================
    # REST API PROXY
    # ================================================
    # Proxy all /api/* requests to backend, stripping /api prefix
    location /api/ {
        # Strip /api prefix when forwarding
        proxy_pass http://clawboard-backend:3001/;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for API requests
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # ================================================
    # DASHBOARD SPA
    # ================================================
    # Serve React app at /dashboard/ with SPA fallback
    location /dashboard {
        # Serve from built static files
        alias /usr/share/nginx/html;
        index index.html;
        
        # SPA fallback: all non-file requests go to index.html
        try_files $uri $uri/ /index.html;

        # ================================================
        # STATIC ASSET CACHING
        # ================================================
        # Cache JavaScript, CSS, fonts, and images for 1 year
        # Vite uses content hashes in filenames, so immutable is safe
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # ================================================
    # HEALTH CHECK
    # ================================================
    # Simple health endpoint for container monitoring
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
